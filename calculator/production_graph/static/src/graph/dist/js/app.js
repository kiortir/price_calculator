(function(e){function t(t){for(var n,c,i=t[0],s=t[1],u=t[2],d=0,f=[];d<i.length;d++)c=i[d],Object.prototype.hasOwnProperty.call(a,c)&&a[c]&&f.push(a[c][0]),a[c]=0;for(n in s)Object.prototype.hasOwnProperty.call(s,n)&&(e[n]=s[n]);l&&l(t);while(f.length)f.shift()();return o.push.apply(o,u||[]),r()}function r(){for(var e,t=0;t<o.length;t++){for(var r=o[t],n=!0,i=1;i<r.length;i++){var s=r[i];0!==a[s]&&(n=!1)}n&&(o.splice(t--,1),e=c(c.s=r[0]))}return e}var n={},a={app:0},o=[];function c(t){if(n[t])return n[t].exports;var r=n[t]={i:t,l:!1,exports:{}};return e[t].call(r.exports,r,r.exports,c),r.l=!0,r.exports}c.m=e,c.c=n,c.d=function(e,t,r){c.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},c.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},c.t=function(e,t){if(1&t&&(e=c(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(c.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)c.d(r,n,function(t){return e[t]}.bind(null,n));return r},c.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return c.d(t,"a",t),t},c.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},c.p="/static/src/graph/dist/";var i=window["webpackJsonp"]=window["webpackJsonp"]||[],s=i.push.bind(i);i.push=t,i=i.slice();for(var u=0;u<i.length;u++)t(i[u]);var l=s;o.push([0,"chunk-vendors"]),r()})({0:function(e,t,r){e.exports=r("56d7")},"56d7":function(e,t,r){"use strict";r.r(t);r("e260"),r("e6cf"),r("cca6"),r("a79d"),r("ac1f"),r("1276"),r("498a");var n=r("f2bf"),a={class:"mt-3"},o={class:"qz-block"},c=Object(n["createElementVNode"])("div",{class:"h3"},"Кварцевый агломерат",-1),i={class:"mb-3"},s=Object(n["createElementVNode"])("label",{for:"qz_spec",class:"form-label"},"Число мастеров",-1),u={id:"chart",class:"apex"},l={class:"ac-block"},d=Object(n["createElementVNode"])("div",{class:"h3"},"Акриловый камень",-1),f={class:"mb-3"},p=Object(n["createElementVNode"])("label",{for:"ac_spec",class:"form-label"},"Число мастеров",-1),h={id:"chart",class:"apex"};function m(e,t,r,m,b,v){var y=Object(n["resolveComponent"])("apexchart");return Object(n["openBlock"])(),Object(n["createElementBlock"])("div",a,[Object(n["createElementVNode"])("div",o,[c,Object(n["createElementVNode"])("div",i,[s,Object(n["withDirectives"])(Object(n["createElementVNode"])("input",{type:"number",class:"form-control",id:"qz_spec","onUpdate:modelValue":t[0]||(t[0]=function(e){return b.qz_specialists=e}),onInput:t[1]||(t[1]=function(){return v.setQzData&&v.setQzData.apply(v,arguments)}),onChange:t[2]||(t[2]=function(e){return v.updateCount("qz_specialists",e.target.value)})},null,544),[[n["vModelText"],b.qz_specialists,void 0,{number:!0}]])]),Object(n["createElementVNode"])("div",u,[Object(n["createVNode"])(y,{ref:"realtimeQzChart",height:600,options:b.chartOptions,series:b.series,onClick:v.clickHandler},null,8,["options","series","onClick"])])]),Object(n["createElementVNode"])("div",l,[d,Object(n["createElementVNode"])("div",f,[p,Object(n["withDirectives"])(Object(n["createElementVNode"])("input",{type:"number",class:"form-control",id:"ac_spec","onUpdate:modelValue":t[3]||(t[3]=function(e){return b.acryl_specialists=e}),onInput:t[4]||(t[4]=function(){return v.setAcData&&v.setAcData.apply(v,arguments)}),onChange:t[5]||(t[5]=function(e){return v.updateCount("acryl_specialists",e.target.value)})},null,544),[[n["vModelText"],b.acryl_specialists,void 0,{number:!0}]])]),Object(n["createElementVNode"])("div",h,[Object(n["createVNode"])(y,{ref:"realtimeAcChart",height:600,options:b.chartOptions,series:b.series,onClick:v.clickHandler},null,8,["options","series","onClick"])])])])}var b=r("ade3"),v=r("b85c"),y=r("2909"),g=r("1da1");r("96cf"),r("b0c0"),r("d3b7"),r("159b"),r("a9e3"),r("5319"),r("4e82"),r("3ca3"),r("ddb0"),r("99af"),r("caad"),r("2532"),r("d81d"),r("b64b"),r("820e");Date.prototype.addDays=function(e){var t=new Date(this.valueOf()).getTime();return new Date(t+864e5*e)};var O={name:"app",data:function(){return{dealdata:[],dayoffs:[],status:null,pollInterval:null,qz_specialists:5,acryl_specialists:5,series:[],chartOptions:{noData:{text:"Загрузка..."},chart:{locales:[{name:"ru",options:{months:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],shortMonths:["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"],days:["Понедельник","Вторник","Среда","Четверг","Пятница","Суббота","Воскресенье"],shortDays:["Вс","Пн","Вт","Ср","Чт","Пт","Сб"],toolbar:{exportToSVG:"Сохранить как SVG",exportToPNG:"Сохранить как  PNG",menu:"Меню",selection:"Выбранная область",selectionZoom:"Приблизить выбранную область",zoomIn:"Приблизить",zoomOut:"Отдалить",pan:"Панорамировать",reset:"Сбросить зум"}}}],type:"rangeBar",defaultLocale:"ru"},plotOptions:{bar:{horizontal:!0,barHeight:"50%",rangeBarGroupRows:!0}},colors:["#008FFB","#00E396","#FEB019","#FF4560","#775DD0","#3F51B5","#546E7A","#D4526E","#8D5B4C","#F86624","#D7263D","#1B998B","#2E294E","#F46036","#E2C044"],fill:{type:"solid"},tooltip:{enabled:!0,y:{formatter:function(e,t){var r=t.seriesIndex,n=t.w;return"Дата заключения: ".concat(new Date(n.config.series[r].data[0].contract_start_date).toLocaleDateString())},title:{formatter:function(e){return e}}}},annotations:{xaxis:[{x:(new Date).getTime(),strokeDashArray:0,borderColor:"#ff0000"}]},dataLabels:{enabled:!0,formatter:function(e,t){var r=t.seriesIndex,n=t.w;return n.config.series[r].name},textAnchor:"middle",style:{fontSize:"0.6em"},distributed:!1,offsetX:0,offsetY:0},xaxis:{type:"datetime"},legend:{show:!1},grid:{xaxis:{lines:{show:!0}}}}}},methods:{addBusyDays:function(e,t){for(var r=0;r<t;r++)e=e.addDays(1),this.isDayoff(e)&&t++;return e},deserializeDayoffs:function(e){return Object(g["a"])(regeneratorRuntime.mark((function t(){var r;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return r=[],e.data.months.forEach((function(t){t.days.split(",").forEach((function(n){r.push(Date.UTC(e.data.year,t.month-1,Number(n.replace(/\D/g,""))))}))})),t.abrupt("return",r);case 3:case"end":return t.stop()}}),t)})))()},getLeads:function(){var e=this;return Object(g["a"])(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.abrupt("return",e.axios.post("/amo/leads").then((function(t){var r=t.data.leads.sort((function(e,t){return e.contract_start_date-t.contract_start_date})),n=[],a=[];r.forEach((function(e){"Акрил"==e.material?a.push(e):n.push(e)})),e.dealdata={qz:n,ac:a}})));case 1:case"end":return t.stop()}}),t)})))()},getDayoffs:function(){var e=this;return Object(g["a"])(regeneratorRuntime.mark((function t(){var r,n,a;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return r=function(){return e.axios.post("/pricelist/prox/",{url:"http://xmlcalendar.ru/data/ru/".concat((new Date).getFullYear()-1,"/calendar.json")}).then((function(t){return e.deserializeDayoffs(t)})).catch((function(){return[]}))},n=function(){return e.axios.post("/pricelist/prox/",{url:"http://xmlcalendar.ru/data/ru/".concat((new Date).getFullYear()+1,"/calendar.json")}).then((function(t){return e.deserializeDayoffs(t)})).catch((function(){return[]}))},a=function(){return e.axios.post("/pricelist/prox/",{url:"http://xmlcalendar.ru/data/ru/".concat((new Date).getFullYear(),"/calendar.json")}).then((function(t){return e.deserializeDayoffs(t)})).catch((function(){return[]}))},t.abrupt("return",Promise.all([r(),n(),a()]).then((function(t){e.dayoffs=[].concat.apply([],Object(y["a"])(t))})).then((function(){0==e.dayoffs.length&&alert("Ошибка! Обновите страницу")})));case 4:case"end":return t.stop()}}),t)})))()},clickHandler:function(e,t,r){e.ctrlKey&&window.open("https://unirock.amocrm.ru/leads/detail/"+r.config.series[r.seriesIndex].data[0].lead)},isDayoff:function(e){return e instanceof Date&&(e=e.getTime()),0!=this.dayoffs.length&&this.dayoffs.includes(e)},firstToFinish:function(e){var t=0,r=1/0;for(var n in e)e[n]<r&&(r=e[n],t=n);return{index:t,value:r}},setQzData:function(){var e=this;return Object(g["a"])(regeneratorRuntime.mark((function t(){var r,n,a,o,c,i,s,u,l;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:r=[],n=Object(y["a"])(Array(e.qz_specialists)).map((function(){return 0})),a=Object(v["a"])(e.dealdata.qz);try{for(a.s();!(o=a.n()).done;)c=o.value,i=1e3*(c.contract_start_date+10800),s=e.firstToFinish(n),u=i>s.value?i:s.value,l=e.addBusyDays(new Date(u),c.work_duration).getTime(),r.push({name:c.contract_number,data:[{lead:c.lead_id,contract_start_date:i,x:"Мастер ".concat(s.index),y:[u,l]}]}),n[s.index]=l}catch(d){a.e(d)}finally{a.f()}e.$refs.realtimeQzChart.updateSeries(r);case 5:case"end":return t.stop()}}),t)})))()},setAcData:function(){var e=this;return Object(g["a"])(regeneratorRuntime.mark((function t(){var r,n,a,o,c,i,s,u,l;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:r=[],n=Object(y["a"])(Array(e.acryl_specialists)).map((function(){return 0})),a=Object(v["a"])(e.dealdata.ac);try{for(a.s();!(o=a.n()).done;)c=o.value,i=1e3*(c.contract_start_date+10800),s=e.firstToFinish(n),u=i>s.value?i:s.value,l=e.addBusyDays(new Date(u),c.work_duration).getTime(),r.push({name:c.contract_number,data:[{lead:c.lead_id,contract_start_date:i,x:"Мастер ".concat(s.index),y:[u,l]}]}),n[s.index]=l}catch(d){a.e(d)}finally{a.f()}e.$refs.realtimeAcChart.updateSeries(r);case 5:case"end":return t.stop()}}),t)})))()},updateCount:function(e,t){this.axios.put("/production/updatecount",Object(b["a"])({},e,t))}},mounted:function(){var e=this,t=function(){var t=Object(g["a"])(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.abrupt("return",new Promise((function(t){var r=JSON.parse(document.getElementById("specialists").textContent);Object.keys(r).forEach((function(n){e[n]=r[n],t()}))})));case 1:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();Promise.allSettled([this.getLeads(),this.getDayoffs(),t()]).then((function(){Promise.all([e.setQzData(),e.setAcData()])}))}},x=r("6b0d"),w=r.n(x);const D=w()(O,[["render",m]]);var j=D,_=r("bc3a"),k=r.n(_),E=r("130e"),z=r("ae27"),C=r.n(z);function N(e){var t=null;if(document.cookie&&""!==document.cookie)for(var r=document.cookie.split(";"),n=0;n<r.length;n++){var a=r[n].trim();if(a.substring(0,e.length+1)===e+"="){t=decodeURIComponent(a.substring(e.length+1));break}}return t}var V=N("csrftoken");k.a.defaults.headers.common={"X-CSRFToken":V};var T=Object(n["createApp"])(j);T.use(C.a),T.use(E["a"],k.a),T.mount("#app")}});